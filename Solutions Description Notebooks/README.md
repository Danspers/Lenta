## Решение Data Science

**Перечень Juputer ноутбуков:** 
1. Исследовательский анализ данных ([EDA](https://github.com/Danspers/Lenta-time-series/blob/main/Solutions%20Description%20Notebooks/1.Lenta_time_series_EDA_(General).ipynb))
2. Создание и тестирование модели [CatBoostRegressor](https://github.com/Danspers/Lenta-time-series/blob/main/Solutions%20Description%20Notebooks/2.Lenta_time_series_CatBoost_(Shcheglova_Natalia).ipynb) с кросс-валидацией и подбором гиперпараметров с `optuna` для топ-50 товаров
3. Создание и тестирование модели [Arima](https://github.com/Danspers/Lenta-time-series/blob/main/Solutions%20Description%20Notebooks/3.Lenta_time_series_Arima_(Skrebcov_Artem).ipynb) для каждой пары товар-магазин для топ-25 товаров
4. Создание и тестирование ансамбля моделей [LinearRegression](https://github.com/Danspers/Lenta-time-series/blob/main/Solutions%20Description%20Notebooks/4.Lenta_time_series_LinearRegression_(Soltyk_Danila).ipynb) для 86% пары товар-магазин (объектов `sales_submission`)

Перед запуском ноутбуков необходимо скачать датасеты из папки [datasets](https://github.com/Danspers/Lenta-time-series/blob/main/Solutions%20Description%20Notebooks/datasets).


## Описание 

I. **Анализ и предобработка:** 
- На этапе анализа данных выявлены и обработаны аномалии: закрытые магазины, возврат товаров (строки с отрицательным спросом и выручкой). 
- Обработаны нулевые значения. 
- Сгенерированы дополнительные фичи. Например: добавлены праздники и выходные, рассчитана цена за единицу товара, для линейной регрессии добавлены скользящее среднее, месяц, день недели и др. 
- Выполнено кодирование признаков `OrdinalEncoder`. Для CatBoost кодирование не требовалось, просто признаки из object преобразованы в category и переданы модели. 
- Проведена предобработка выборки `sales_submission` - это датасет, который используется для прогнозирования. 

II. **Моделирование** 
В ходе проекта мы подготовили три модели: 

- `CatBoostRegressor` обучен на всем пространстве признаков для топ-50 товаров (отобранных по максимальной выручке) с применением кросс-валидации для временных рядов (5 ступеней) и оптимизацией гиперпараметров с помощью `optuna`. Дополнительные признаки - расчетная цена за единицу товара и праздники. Разделение на пар товар-магазин намеренно не проводилось при обучении, поскольку предполагалось, что модель самостоятельно выявит закономерности между товарами (каннибализация или гало эффект). _WAPE_ лучшей модели на тесте 0.39.

- Ансамбль `LinearRegression` построен для большинства пар товар-магазин (отобранных по максимальной выручке). Дополнительные признак - лаговые значения,  скользящее среднее, месяц, день месяца и недели. Выполнено масштабирование признаков `StandardScaler`.  Лучшая _WAPE_ модели 0.40.

- `Arima` построена для топ-25 наиболее часто продающихся товаров, прогноз дает для каждой пары товар-магазин. В качестве признаков использовались названия товаров, магазинов и даты. Усредненный _WAPE_ модели на тесте 0.69. 

Была проведена оценка важности признаков с помощью `SHAP`, что позволило выявить наиболее влиятельный признак - это цена за единицу товара. 


### Сравнение моделей
- На данный момент лучшая метрика у `CatBoostRegressor` (_WAPE_ = 0.39), но алгоритм долго обучается (около 9 минут с подбором гиперпапаметров и кросс-валидацией). Прогноз делается почти мгновенно для топ-50 товаров. 
- Скорость обучения у ансамбля из `LinearRegression` средняя: 3-5 минут. Метрика при этом почти не отличается от CatBoost (_WAPE_ = 0.40).
- `Arima` показала метрику (_WAPE_ = 0.69) с самой высокой скоростью работы 4 секунды (4 минуты для модели с подбором параметров). Ее в дальнейшем можно использовать для прогнозирования средней цены на товар, которую использовать в качестве дополнительной фичи для подачи на вход бустингу, линейной регрессии или деревянной модели. 


<img src="https://upload.wikimedia.org/wikipedia/commons/b/ba/Warning_sign_4.0.png" align=left width=44, heigth=33>


**ПЛАН ДЛЯ УЛУЧШЕНИЯ ПОКАЗАТЕЛЕЙ** 
___________________________
- Провести кластеризацию для определения похожих пар товар-магазин, а затем строить модели по группам, а не по отдельным товарам или общему полю признаков. Это позволит сэкономить вычислительные и временнЫе ресурсы. Оптимальный вариант, чтобы охватить бОльшее количество товаров, но не уронить качество. 
- Двухэтапное прогнозирование. На первом этапе прогнозировать среднюю цену на товары с помощью Аримы или Профета, а затем подавать ее в качестве дополнительной фичи на вход на бустинг или линейную модель, что позволит повысить качество финального прогноза спроса. 
- Сгенерировать дополнительные признаки (например, rolling_mean, месяц, день недели для бустинга) или использовать библиотеку TSFresh для создания новых признаков, которые можно подать на любую модель. 
