**СОДЕРЖАНИЕ** 

1. Анализ данных и фича инжиниринг 
2. Создание и тестирование модели CatBoostRegressor с кросс-валидацией и подбором гиперпараметров с optuna для топ-50 товаров
3. Создание и тестирование модели Linear regression для кадой пары товар-магазин 
4. Создание и тестирование модели Arima для каждой пары товар-магазин для топ-25 товаров

**ИНСТРУКЦИЯ ПО ЗАПУСКУ:** 

Перед запуском ноутбуков необходимо скачать файлы с данными из папки `Lenta-time-series/datasets`, находящейся в данном репозитории. 

**ОПИСАНИЕ РЕШЕНИЯ:** 

I. **Анализ и предобработка:** 

- На этапе анализа данных выявлены и обработаны аномалии: закрытые магазины, возврат товаров (строки с отрицательным спросом и выручкой). 
- Обработаны пропуски и нулевыезначения. 
- Сгенерированы дополнительные фичи, например, добавлены праздники и выходные, рассчитана цена за единицу товара, для линейной регрессии добавлены rolling_mean, месяц, день недели и др. 
- Выполнено кодирование признаков OrdinalEncoder. Для CatBoost кодирование не требовалось, просто признаки из object преобразованы в category и переданы модели. 
- Проведена предобработка выборки sales_submission - это датасет, который используется для прогнозирования. 

II. **Моделирование:** 

В ходе проекта мы подготовии три модели: 

- CatBoostRegressor обучен на всем пространстве призноков для топ-50 товаров (отобранных по максимальной выручке) с применением кросс-валидации для временных рядов (5 ступеней) и оптимизацией гиперпараметров с помощью optuna. Дополнителне признаки - расчетная цена за единицу товара и праздники. Разделение на пар товар-магазин намеренно не проводилось при обучении, поскольку предполагалось, что модель самостоятельно выявит закономерности между товарами (каннибализация или гало эффект). WAPE лучшей модели на тесте 0.39.

- Linear regression построена для нескольких пар товар-магазин (отобранных по максимальной выручке). Дополнителный признак - цена за единицу товара,  rolling_mean, месяц, день недели. Выполнено кодирование признаков OrdinalEncoder.  WAPE лучшей модели на тесте 0.40.

- Arima построена для топ-25 наиболее часто продающихся товаров, прогноз дает для каждой пары товар-магазин. В качестве признаков использовались названия товаров, магазинов и даты. Усредненный WAPE модели на тесте 0.69. 

Была проведена оценка важности признаков с помощью SHAP, что позволило выявить наиболее влиятельный признак - это цена за единицу товара. 

**Сравнение моделей:**

- На данный момент лучшая метрика у CatBoostRegressor (WAPE = 0.39), но алгоритм долго обучается (около 9 минут с подбором гиперпапаметров и кросс-валидацией). Прогноз делается почти мгновенно для топ-50 товаров. 
- Самая всокая скорость обучения у Linear regression, на порядок выше, чем у бустинга. Мертика при этом пости не отличается от Катбуста (WAPE = 0.40).
- Арима показала метрику (WAPE = 0.69) со скоростью работы 4 секунды (4 минуты для модели с подбором параметров). Ее в дальнейшем можно использовать для прогнозирования средней цены на товар, которую использовать в качестве дополнительной фичи для подачи на вход бустингу или линейной или деревянной модели. 


<img src="https://upload.wikimedia.org/wikipedia/commons/b/ba/Warning_sign_4.0.png" align=left width=44, heigth=33>


**ПЛАН ДЛЯ УЛУЧШЕНИЯ ПОКАЗАТЕЛЕЙ** 
___________________________
- Провести кластеризацию для определения похожих пар товар-магазин, а затем строить модели по группам, а не по отдельным товарам или общему полю признаков. Это позволит сэкономить вычислительняе и временнЫе ресурсы. Оптимальный вариант, чтобы охватить бОльшее количество товаров, но не уронить качество. 
- Двухэтапное прогнозирование. На первом этапе прогнозировать среднюю цену на товары с помощью Аримы или Профета, а затем подавать ее в качестве дополнительной фичи на вход на бустинг или линейную модель, что позволит повысить качество финалного прогноза спроса. 
- Сгененрировать дополнительные признаки (например, rolling_mean, месяц, день недели для бустинга) или использовать библиотеку TSFresh для создания новых признаков, которые можно подать на любую модель. 



 
